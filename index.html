<!DOCTYPE html>
<html>
<head>
    <title>AI Competitor Monitor - Enhanced Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            padding: 40px 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-bottom: 2px solid #0f4c75;
        }
        h1 {
            color: #3bb4f1;
            font-size: 2.5em;
            margin: 0;
        }
        .subtitle {
            color: #888;
            margin-top: 10px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            border-bottom: 2px solid #0f4c75;
        }
        .tab {
            background: transparent;
            color: #888;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        .tab.active {
            color: #3bb4f1;
            border-bottom-color: #3bb4f1;
        }
        .tab:hover {
            color: #3bb4f1;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Auth Section */
        .auth-section {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #0f4c75;
        }
        .auth-section h2 {
            margin-top: 0;
        }
        
        /* Form Controls */
        input[type="text"],
        input[type="number"],
        input[type="password"],
        select,
        textarea {
            background: #1a1a2e;
            border: 1px solid #0f4c75;
            color: #eee;
            padding: 10px;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            margin: 5px 0;
        }
        
        button {
            background: #3bb4f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #2a9fd8;
        }
        
        /* Controls */
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        /* Status Grid */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .status-card {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #0f4c75;
            text-align: center;
        }
        .status-value {
            font-size: 2em;
            color: #3bb4f1;
            margin: 10px 0;
        }
        .status-label {
            color: #888;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        
        /* Configuration Section */
        .config-section {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #0f4c75;
        }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .config-item {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #0f4c75;
        }
        .config-item h4 {
            margin-top: 0;
            color: #3bb4f1;
        }
        
        /* Data Table */
        .data-table {
            width: 100%;
            background: #16213e;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }
        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th {
            background: #0f4c75;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: normal;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #0f4c75;
        }
        .data-table tr:hover {
            background: #1a1a2e;
        }
        
        /* Change Viewer */
        .change-viewer {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #0f4c75;
        }
        .diff-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .diff-side {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #0f4c75;
            max-height: 400px;
            overflow-y: auto;
        }
        .diff-added {
            background: rgba(39, 174, 96, 0.2);
            color: #2ecc71;
        }
        .diff-removed {
            background: rgba(192, 57, 43, 0.2);
            color: #e74c3c;
        }
        
        /* Threshold Indicators */
        .threshold-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            margin-left: 10px;
        }
        .threshold-low {
            background: #27ae60;
            color: white;
        }
        .threshold-medium {
            background: #f39c12;
            color: white;
        }
        .threshold-high {
            background: #e74c3c;
            color: white;
        }
        
        /* AI Score */
        .ai-score {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            color: white;
        }
        .ai-score-low {
            background: #95a5a6;
        }
        .ai-score-medium {
            background: #f39c12;
        }
        .ai-score-high {
            background: #e74c3c;
        }
        
        /* Messages */
        .error {
            background: #c0392b;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .info {
            background: #3498db;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        /* Log Area */
        .log-area {
            background: #0f0f23;
            border: 1px solid #0f4c75;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        /* Utilities */
        .hidden {
            display: none;
        }
        .mb-10 {
            margin-bottom: 10px;
        }
        .flex {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3bb4f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>AI Competitor Monitor</h1>
        <p class="subtitle">Real-time Intelligence on AI Industry Changes</p>
    </div>
    
    <div class="container">
        <div class="auth-section">
            <h2>Authentication</h2>
            <p>Enter your API token to access the monitoring system:</p>
            <div class="flex">
                <input type="password" id="apiToken" placeholder="Enter API token" style="width: 300px;">
                <button onclick="saveToken()">Save Token</button>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="switchTab('extracted')">Extracted Data</button>
            <button class="tab" onclick="switchTab('changes')">Change History</button>
            <button class="tab" onclick="switchTab('config')">Configuration</button>
            <button class="tab" onclick="switchTab('brain')">üß† TheBrain</button>
            <button class="tab" onclick="switchTab('logs')">System Logs</button>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="controls">
                <button onclick="checkStatus()">üîÑ Refresh Status</button>
                <button onclick="generateBaseline()">üìä Generate Baseline</button>
                <button onclick="runMonitorCheck()">üîç Run Monitor Check</button>
                <button onclick="runIntelligentMonitor()">üß† Run AI Analysis</button>
                <button onclick="testTheBrain()">üß† Test TheBrain</button>
            </div>
            
            <h2>System Status</h2>
            <div class="status-grid">
                <div class="status-card">
                    <div class="status-value" id="systemStatus">checking...</div>
                    <div class="status-label">STATUS</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="companyCount">0</div>
                    <div class="status-label">COMPANIES</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="urlCount">0</div>
                    <div class="status-label">URLS TRACKED</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="lastCheck">Never</div>
                    <div class="status-label">LAST CHECK</div>
                </div>
            </div>
            
            <div id="messageArea"></div>
            
            <!-- Recent Changes Summary -->
            <div class="change-viewer">
                <h3>Recent Significant Changes</h3>
                <div id="recentChanges">
                    <p style="color: #888;">No recent changes detected.</p>
                </div>
            </div>
        </div>
        
        <!-- Extracted Data Tab -->
        <div id="extracted-tab" class="tab-content">
            <h2>Extracted Content</h2>
            <button onclick="loadExtractedData()" class="mb-10">üîÑ Refresh Data</button>
            
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>URL</th>
                            <th>Title</th>
                            <th>Word Count</th>
                            <th>Preview</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="extractedDataTable">
                        <tr><td colspan="6" style="text-align: center; color: #888;">Click refresh to load data</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Change History Tab -->
        <div id="changes-tab" class="tab-content">
            <h2>Change History</h2>
            <div class="flex mb-10">
                <select id="changeUrlFilter" style="width: 300px;">
                    <option value="">All URLs</option>
                </select>
                <button onclick="loadChangeHistory()">üîÑ Load Changes</button>
            </div>
            
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Company</th>
                            <th>URL</th>
                            <th>Change %</th>
                            <th>AI Score</th>
                            <th>Summary</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="changeHistoryTable">
                        <tr><td colspan="7" style="text-align: center; color: #888;">Select URL and load changes</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Diff Viewer -->
            <div class="change-viewer hidden" id="diffViewer">
                <h3>Change Comparison</h3>
                <div class="diff-container">
                    <div class="diff-side">
                        <h4>Previous Version</h4>
                        <div id="diffBefore"></div>
                    </div>
                    <div class="diff-side">
                        <h4>Current Version</h4>
                        <div id="diffAfter"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Configuration Tab -->
        <div id="config-tab" class="tab-content">
            <h2>Configuration Management</h2>
            
            <!-- Threshold Configuration -->
            <div class="config-section">
                <h3>Change Detection Thresholds</h3>
                <div class="config-grid">
                    <div class="config-item">
                        <h4>Global Threshold</h4>
                        <input type="number" id="globalThreshold" min="1" max="100" value="25">
                        <label>% change to trigger alert</label>
                    </div>
                    <div class="config-item">
                        <h4>AI Alert Threshold</h4>
                        <input type="number" id="aiThreshold" min="1" max="10" value="6">
                        <label>Minimum AI score (1-10)</label>
                    </div>
                </div>
                
                <h4>Company-Specific Thresholds</h4>
                <div id="companyThresholds" class="config-grid"></div>
                
                <h4>Page-Specific Rules</h4>
                <div id="pageThresholds" class="config-grid"></div>
                
                <button onclick="saveThresholds()">üíæ Save Thresholds</button>
            </div>
            
            <!-- Monitor Configuration -->
            <div class="config-section">
                <h3>Monitored Companies</h3>
                <div id="monitorList"></div>
                <button onclick="addMonitor()">‚ûï Add Company</button>
            </div>
            
            <!-- CSS Selectors -->
            <div class="config-section">
                <h3>Content Extraction Selectors</h3>
                <div class="config-item">
                    <h4>Default Content Selector</h4>
                    <input type="text" id="defaultSelector" value="main, article, .content, #content">
                </div>
                <div class="config-item">
                    <h4>Exclude Selector</h4>
                    <input type="text" id="excludeSelector" value="nav, header, footer, .sidebar, .ads">
                </div>
                <button onclick="saveSelectors()">üíæ Save Selectors</button>
            </div>
        </div>
        
        <!-- TheBrain Tab -->
        <div id="brain-tab" class="tab-content">
            <h2>üß† TheBrain Knowledge Mapping</h2>
            <p>Visualize competitive intelligence as dynamic knowledge maps</p>
            
            <!-- TheBrain Status -->
            <div class="status-grid">
                <div class="status-card">
                    <div class="status-value" id="brainStatus">checking...</div>
                    <div class="status-label">BRAIN STATUS</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="brainThoughts">0</div>
                    <div class="status-label">THOUGHTS</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="brainConnections">0</div>
                    <div class="status-label">CONNECTIONS</div>
                </div>
            </div>
            
            <!-- TheBrain Controls -->
            <div class="config-section">
                <h3>Brain Management</h3>
                <div class="controls">
                    <button onclick="testTheBrainConnection()">üîó Test Connection</button>
                    <button onclick="createCompetitiveBrain()">üß† Create Intelligence Brain</button>
                    <button onclick="addCompaniesToBrain()">üè¢ Add Companies</button>
                    <button onclick="generateLandscapeAnalysis()">üìä Generate Analysis</button>
                </div>
            </div>
            
            <!-- Integration Status -->
            <div class="config-section">
                <h3>Integration Status</h3>
                <div id="brainIntegrationStatus">
                    <p>Loading TheBrain integration status...</p>
                </div>
            </div>
            
            <!-- Recent Brain Activity -->
            <div class="config-section">
                <h3>Recent Brain Activity</h3>
                <div id="brainActivity">
                    <p>No brain activity to display yet.</p>
                </div>
            </div>
        </div>
        
        <!-- System Logs Tab -->
        <div id="logs-tab" class="tab-content">
            <h2>System Logs</h2>
            <button onclick="loadLogs()">üîÑ Refresh Logs</button>
            <div class="log-area" id="logArea"></div>
        </div>
    </div>
    
    <script>
        // Update API endpoint to latest version
        const API_BASE = 'https://script.google.com/macros/s/AKfycbzurgALyAIUPshpWhdfglcM0Anuiudtt0aSVVa3bu7swjx_F9L0GsrzkmVwmKoInd66Ag/exec';
        let apiToken = '';
        let currentConfig = null;
        let currentMonitors = [];
        
        // Enhanced logging
        const log = (message, data = null) => {
            const timestamp = new Date().toISOString();
            console.log(`[${timestamp}] ${message}`, data || '');
            
            // Also add to visible log if on logs tab
            const logArea = document.getElementById('logArea');
            if (logArea && document.getElementById('logs-tab').classList.contains('active')) {
                logArea.innerHTML = `[${timestamp}] ${message} ${data ? JSON.stringify(data) : ''}\n` + logArea.innerHTML;
            }
        };
        
        // Initialize with clean token
        function initializeApp() {
            // Clear any corrupted token
            const storedToken = localStorage.getItem('apiToken') || '';
            // Clean the token - remove any duplicates and Bearer prefix
            if (storedToken.includes('dev-token-change-me')) {
                apiToken = 'dev-token-change-me';
                localStorage.setItem('apiToken', apiToken);
                log('Cleaned corrupted token');
            } else {
                // Remove Bearer prefix if present
                apiToken = storedToken.replace(/^Bearer/i, '').trim();
            }
            
            if (apiToken) {
                document.getElementById('apiToken').value = apiToken;
                log('Loaded token from storage', { token: apiToken.substring(0, 10) + '...' });
                checkStatus();
            }
        }
        
        // Call initialization
        initializeApp();
        
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'config' && currentConfig === null) {
                loadConfiguration();
            } else if (tabName === 'brain') {
                loadTheBrainStatus();
            }
        }
        
        function saveToken() {
            const newToken = document.getElementById('apiToken').value;
            log('Saving token', { length: newToken.length });
            
            // Ensure clean token storage
            apiToken = newToken;
            localStorage.setItem('apiToken', apiToken);
            
            // Verify storage
            const verified = localStorage.getItem('apiToken');
            if (verified === apiToken) {
                showMessage('Token saved successfully', 'success');
                log('Token verified after save');
            } else {
                showMessage('Token save verification failed!', 'error');
                log('Token verification failed', { expected: apiToken, actual: verified });
            }
            
            checkStatus();
        }
        
        function showMessage(message, type = 'error') {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="${type}">${message}</div>`;
            if (type === 'success') {
                setTimeout(() => messageArea.innerHTML = '', 5000);
            }
        }
        
        async function makeRequest(action, params = {}) {
            try {
                const url = new URL(API_BASE);
                // FIXED: Ensure clean token without 'Bearer' prefix
                const cleanToken = apiToken.replace(/^Bearer/i, '').trim();
                url.searchParams.append('token', cleanToken);
                url.searchParams.append('action', action);
                Object.keys(params).forEach(key => {
                    url.searchParams.append(key, typeof params[key] === 'object' ? JSON.stringify(params[key]) : params[key]);
                });
                
                log(`API Request: ${action}`, { 
                    url: url.toString().replace(apiToken, '***'), 
                    params: params 
                });
                
                const response = await fetch(url.toString());
                const responseText = await response.text();
                
                log(`API Response: ${action}`, { 
                    status: response.status,
                    contentLength: responseText.length 
                });
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    log('Failed to parse response', { responseText: responseText.substring(0, 200) });
                    throw new Error('Invalid response format');
                }
                
                if (!data.success) {
                    log('API Error', { action: action, error: data.error });
                    throw new Error(data.error || 'Request failed');
                }
                
                return data;
            } catch (error) {
                log('Request failed', { action: action, error: error.message });
                showMessage(`Error: ${error.message}`);
                throw error;
            }
        }
        
        async function checkStatus() {
            try {
                log('Checking system status');
                const data = await makeRequest('status');
                
                log('Status response', {
                    health: data.health,
                    companies: data.companiesMonitored,
                    urls: data.urlsTracked,
                    lastCheck: data.lastCheck
                });
                
                document.getElementById('systemStatus').textContent = data.health || 'operational';
                
                // Update counts directly from status response
                if (data.companiesMonitored !== undefined) {
                    document.getElementById('companyCount').textContent = data.companiesMonitored;
                }
                if (data.urlsTracked !== undefined) {
                    document.getElementById('urlCount').textContent = data.urlsTracked;
                }
                
                // Update last check
                if (data.lastCheck && data.lastCheck !== 'never') {
                    const date = new Date(data.lastCheck);
                    document.getElementById('lastCheck').textContent = date.toLocaleString();
                } else {
                    document.getElementById('lastCheck').textContent = 'Never';
                }
                
                // Load configuration for additional data
                await loadConfiguration();
                
            } catch (error) {
                log('Status check failed', { error: error.message });
                document.getElementById('systemStatus').textContent = 'error';
            }
        }
        
        async function loadConfiguration() {
            try {
                const data = await makeRequest('config');
                currentConfig = data.config;
                currentMonitors = data.monitors || [];
                
                // Update URL count
                const totalUrls = currentMonitors.reduce((sum, m) => sum + (m.urls ? m.urls.length : 0), 0);
                document.getElementById('urlCount').textContent = totalUrls;
                document.getElementById('companyCount').textContent = currentMonitors.length;
                
                // Update configuration UI
                if (currentConfig) {
                    updateConfigUI();
                }
                
                // Update URL filter dropdown
                updateUrlFilter();
                
            } catch (error) {
                console.error('Failed to load configuration:', error);
            }
        }
        
        function updateConfigUI() {
            if (!currentConfig) return;
            
            // Update threshold inputs
            if (currentConfig.thresholds) {
                document.getElementById('globalThreshold').value = currentConfig.thresholds.global || 25;
            }
            if (currentConfig.aiThresholds) {
                document.getElementById('aiThreshold').value = currentConfig.aiThresholds.alertThreshold || 6;
            }
            
            // Update company thresholds
            const companyDiv = document.getElementById('companyThresholds');
            companyDiv.innerHTML = currentMonitors.map(monitor => `
                <div class="config-item">
                    <h4>${monitor.company}</h4>
                    <input type="number" id="threshold-${monitor.company.replace(/\s+/g, '-')}" 
                           min="1" max="100" 
                           value="${currentConfig.thresholds?.company?.[monitor.company] || currentConfig.thresholds?.global || 25}">
                    <label>% change threshold</label>
                </div>
            `).join('');
            
            // Update monitor list
            const monitorDiv = document.getElementById('monitorList');
            monitorDiv.innerHTML = currentMonitors.map(monitor => `
                <div class="config-item">
                    <h4>${monitor.company}</h4>
                    <p>URLs: ${monitor.urls.join(', ')}</p>
                    <button onclick="editMonitor('${monitor.company}')">Edit</button>
                    <button onclick="removeMonitor('${monitor.company}')">Remove</button>
                </div>
            `).join('');
            
            // Update selectors
            if (currentConfig.contentSelectors) {
                document.getElementById('defaultSelector').value = currentConfig.contentSelectors.default || '';
                document.getElementById('excludeSelector').value = currentConfig.contentSelectors.exclude || '';
            }
        }
        
        function updateUrlFilter() {
            const select = document.getElementById('changeUrlFilter');
            select.innerHTML = '<option value="">All URLs</option>';
            
            currentMonitors.forEach(monitor => {
                monitor.urls.forEach(url => {
                    select.innerHTML += `<option value="${url}">${monitor.company} - ${url}</option>`;
                });
            });
        }
        
        async function generateBaseline() {
            try {
                log('Starting baseline generation');
                showMessage('Generating baseline... this may take a few minutes', 'info');
                
                const startTime = Date.now();
                const data = await makeRequest('baseline');
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                
                log('Baseline generation completed', { 
                    duration: `${duration}s`,
                    companies: data.companies,
                    results: data.results?.length || 0
                });
                
                showMessage(`Baseline generated: ${data.companies} companies processed in ${duration}s`, 'success');
                checkStatus();
            } catch (error) {
                log('Baseline generation failed', { error: error.message });
                showMessage(`Baseline generation failed: ${error.message}`);
            }
        }
        
        async function runMonitorCheck() {
            try {
                showMessage('Running monitor check... this may take a few minutes', 'info');
                const data = await makeRequest('monitor', { checkAll: true });
                showMessage(`Monitor check completed: ${data.relevantChanges || 0} changes detected`, 'success');
                checkStatus();
                loadRecentChanges();
            } catch (error) {
                showMessage(`Monitor check failed: ${error.message}`);
            }
        }
        
        async function runIntelligentMonitor() {
            try {
                showMessage('Running AI-powered analysis... this may take several minutes', 'info');
                const data = await makeRequest('execute', { 
                    functionName: 'processIntelligentMonitor',
                    parameters: JSON.stringify([{ company: 'all' }])
                });
                showMessage(`AI analysis completed: ${data.result?.summary?.significantChanges || 0} significant changes detected`, 'success');
                checkStatus();
                loadRecentChanges();
            } catch (error) {
                showMessage(`AI analysis failed: ${error.message}`);
            }
        }
        
        async function loadExtractedData() {
            try {
                log('Loading extracted data');
                const data = await makeRequest('execute', {
                    functionName: 'getExtractedData',
                    parameters: '[]'
                });
                
                log('Extracted data response', { 
                    success: data.success,
                    hasResult: !!data.result,
                    dataCount: data.result?.data?.length || 0
                });
                
                const tbody = document.getElementById('extractedDataTable');
                if (data.result?.data && data.result.data.length > 0) {
                    tbody.innerHTML = data.result.data.map(item => `
                        <tr>
                            <td>${new Date(item.timestamp).toLocaleString()}</td>
                            <td><a href="${item.url}" target="_blank">${item.url}</a></td>
                            <td>${item.title || 'N/A'}</td>
                            <td>${item.wordCount || 0}</td>
                            <td>${item.preview?.substring(0, 100)}...</td>
                            <td><button onclick="viewContent('${item.url}', '${item.timestamp}')">View</button></td>
                        </tr>
                    `).join('');
                    log(`Displayed ${data.result.data.length} extracted data items`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #888;">No extracted data found</td></tr>';
                    log('No extracted data to display');
                }
            } catch (error) {
                log('Failed to load extracted data', { error: error.message });
                const tbody = document.getElementById('extractedDataTable');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #c0392b;">Error loading data: ' + error.message + '</td></tr>';
            }
        }
        
        async function loadChangeHistory() {
            try {
                const urlFilter = document.getElementById('changeUrlFilter').value;
                const data = await makeRequest('execute', {
                    functionName: 'getChangeHistory',
                    parameters: JSON.stringify([urlFilter])
                });
                
                const tbody = document.getElementById('changeHistoryTable');
                if (data.result?.changes && data.result.changes.length > 0) {
                    tbody.innerHTML = data.result.changes.map(change => {
                        const aiScoreClass = change.relevanceScore >= 8 ? 'ai-score-high' : 
                                           change.relevanceScore >= 6 ? 'ai-score-medium' : 'ai-score-low';
                        return `
                            <tr>
                                <td>${new Date(change.timestamp).toLocaleString()}</td>
                                <td>${change.company}</td>
                                <td><a href="${change.url}" target="_blank">${change.url.substring(0, 50)}...</a></td>
                                <td><span class="threshold-indicator ${getThresholdClass(change.changeMagnitude)}">${change.changeMagnitude || 0}%</span></td>
                                <td><span class="ai-score ${aiScoreClass}">${change.relevanceScore || 0}</span></td>
                                <td>${change.summary || 'N/A'}</td>
                                <td><button onclick="viewDiff('${change.url}', '${change.timestamp}')">View Diff</button></td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888;">No changes found</td></tr>';
                }
            } catch (error) {
                console.error('Failed to load change history:', error);
            }
        }
        
        async function loadRecentChanges() {
            try {
                const data = await makeRequest('execute', {
                    functionName: 'getChangeHistory',
                    parameters: JSON.stringify([''])
                });
                
                const container = document.getElementById('recentChanges');
                if (data.result?.changes && data.result.changes.length > 0) {
                    const recentChanges = data.result.changes.slice(0, 5);
                    container.innerHTML = recentChanges.map(change => `
                        <div class="config-item">
                            <h4>${change.company} - ${new Date(change.timestamp).toLocaleString()}</h4>
                            <p><strong>URL:</strong> ${change.url}</p>
                            <p><strong>Change:</strong> ${change.changeMagnitude || 0}% | <strong>AI Score:</strong> ${change.relevanceScore || 0}/10</p>
                            <p><strong>Summary:</strong> ${change.summary || 'N/A'}</p>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color: #888;">No recent changes detected.</p>';
                }
            } catch (error) {
                console.error('Failed to load recent changes:', error);
            }
        }
        
        function getThresholdClass(magnitude) {
            if (magnitude >= 50) return 'threshold-high';
            if (magnitude >= 25) return 'threshold-medium';
            return 'threshold-low';
        }
        
        async function saveThresholds() {
            try {
                const updates = {
                    global: parseInt(document.getElementById('globalThreshold').value),
                    company: {},
                    ai: {
                        alertThreshold: parseInt(document.getElementById('aiThreshold').value)
                    }
                };
                
                // Collect company thresholds
                currentMonitors.forEach(monitor => {
                    const input = document.getElementById(`threshold-${monitor.company.replace(/\s+/g, '-')}`);
                    if (input) {
                        updates.company[monitor.company] = parseInt(input.value);
                    }
                });
                
                await makeRequest('execute', {
                    functionName: 'updateThresholds',
                    parameters: JSON.stringify([updates])
                });
                
                showMessage('Thresholds saved successfully', 'success');
                loadConfiguration();
            } catch (error) {
                showMessage(`Failed to save thresholds: ${error.message}`);
            }
        }
        
        async function saveSelectors() {
            try {
                const updates = {
                    default: document.getElementById('defaultSelector').value,
                    exclude: document.getElementById('excludeSelector').value
                };
                
                await makeRequest('execute', {
                    functionName: 'updateSelectors',
                    parameters: JSON.stringify([updates])
                });
                
                showMessage('Selectors saved successfully', 'success');
                loadConfiguration();
            } catch (error) {
                showMessage(`Failed to save selectors: ${error.message}`);
            }
        }
        
        async function loadLogs() {
            try {
                const data = await makeRequest('logs', { limit: 100 });
                const logArea = document.getElementById('logArea');
                
                if (data.logs && data.logs.length > 0) {
                    logArea.innerHTML = data.logs.map(log => 
                        `[${log.timestamp}] ${log.type}: ${log.message}`
                    ).join('\n');
                } else {
                    logArea.innerHTML = 'No logs available';
                }
            } catch (error) {
                showMessage(`Failed to load logs: ${error.message}`);
            }
        }
        
        // ============ THEBRAIN FUNCTIONS ============
        
        async function testTheBrain() {
            try {
                showMessage('Testing TheBrain integration...', 'info');
                const data = await makeRequest('execute', {
                    functionName: 'testTheBrainIntegration',
                    parameters: '[]'
                });
                
                if (data.success && data.result.success) {
                    showMessage(`üß† TheBrain integration test successful! Brain ID: ${data.result.brainId}`, 'success');
                    loadTheBrainStatus();
                } else {
                    showMessage(`üß† TheBrain test failed: ${data.result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showMessage(`TheBrain test failed: ${error.message}`, 'error');
            }
        }
        
        async function testTheBrainConnection() {
            try {
                log('Testing TheBrain connection');
                showMessage('Testing TheBrain connection...', 'info');
                const data = await makeRequest('execute', {
                    functionName: 'testTheBrainConnection',
                    parameters: '[]'
                });
                
                log('TheBrain connection response', { 
                    success: data.success, 
                    result: data.result 
                });
                
                if (data.success && data.result.success) {
                    showMessage('üîó TheBrain connection successful!', 'success');
                    document.getElementById('brainStatus').textContent = 'Connected';
                } else {
                    const error = data.result?.error || 'Unknown error';
                    log('TheBrain connection failed', { error: error });
                    showMessage(`Connection failed: ${error}`, 'error');
                    document.getElementById('brainStatus').textContent = 'Disconnected';
                }
            } catch (error) {
                log('TheBrain connection test error', { error: error.message });
                showMessage(`Connection test failed: ${error.message}`, 'error');
                document.getElementById('brainStatus').textContent = 'Error';
            }
        }
        
        async function createCompetitiveBrain() {
            try {
                showMessage('Creating competitive intelligence brain...', 'info');
                const data = await makeRequest('execute', {
                    functionName: 'createCompetitiveIntelligenceBrain',
                    parameters: '[]'
                });
                
                if (data.success && data.result.success) {
                    showMessage(`üß† Competitive intelligence brain created successfully!`, 'success');
                    loadTheBrainStatus();
                } else {
                    showMessage(`Brain creation failed: ${data.result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`Brain creation failed: ${error.message}`, 'error');
            }
        }
        
        async function addCompaniesToBrain() {
            try {
                showMessage('Adding companies to brain...', 'info');
                const data = await makeRequest('execute', {
                    functionName: 'addCompaniesToBrain',
                    parameters: '[]'
                });
                
                if (data.success && data.result.success) {
                    showMessage(`üè¢ ${data.result.companiesAdded} companies added to brain!`, 'success');
                    loadTheBrainStatus();
                } else {
                    showMessage(`Adding companies failed: ${data.result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`Adding companies failed: ${error.message}`, 'error');
            }
        }
        
        async function generateLandscapeAnalysis() {
            try {
                showMessage('Generating competitive landscape analysis...', 'info');
                const data = await makeRequest('execute', {
                    functionName: 'generateCompetitiveLandscape',
                    parameters: '[]'
                });
                
                if (data.success && data.result.success) {
                    showMessage(`üìä Competitive landscape analysis generated! Companies analyzed: ${data.result.companiesAnalyzed}`, 'success');
                    loadTheBrainStatus();
                } else {
                    showMessage(`Analysis generation failed: ${data.result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`Analysis generation failed: ${error.message}`, 'error');
            }
        }
        
        async function loadTheBrainStatus() {
            try {
                const data = await makeRequest('execute', {
                    functionName: 'getTheBrainStatus',
                    parameters: '[]'
                });
                
                if (data.success && data.result) {
                    const status = data.result;
                    
                    // Update status display
                    document.getElementById('brainStatus').textContent = status.enabled ? 'Enabled' : 'Disabled';
                    
                    // Update integration status
                    const statusDiv = document.getElementById('brainIntegrationStatus');
                    statusDiv.innerHTML = `
                        <div class="config-item">
                            <h4>Integration Status</h4>
                            <p><strong>Enabled:</strong> ${status.enabled ? '‚úÖ Yes' : '‚ùå No'}</p>
                            <p><strong>API Key:</strong> ${status.apiKey === 'configured' ? '‚úÖ Configured' : '‚ùå Missing'}</p>
                            <p><strong>Brain ID:</strong> ${status.brainId || 'Not created'}</p>
                            <p><strong>Brain Name:</strong> ${status.brainName}</p>
                            <p><strong>Categories:</strong> ${status.categories}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load TheBrain status:', error);
            }
        }
        
        // ============ PLACEHOLDER FUNCTIONS ============
        
        function viewContent(url, timestamp) {
            alert(`View content for ${url} at ${timestamp} - Coming soon!`);
        }
        
        function viewDiff(url, timestamp) {
            alert(`View diff for ${url} at ${timestamp} - Coming soon!`);
        }
        
        function editMonitor(company) {
            alert(`Edit monitor for ${company} - Coming soon!`);
        }
        
        function removeMonitor(company) {
            if (confirm(`Remove monitor for ${company}?`)) {
                alert('Remove functionality coming soon!');
            }
        }
        
        function addMonitor() {
            alert('Add monitor functionality coming soon!');
        }
        
        // Auto-refresh status every 60 seconds
        setInterval(() => {
            if (apiToken) checkStatus();
        }, 60000);
    </script>
</body>
</html>